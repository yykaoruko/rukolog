name: Create PR

on: repository_dispatch
jobs:
  build:

    runs-on: ubuntu-latest

    steps:

    - name: Checkout master
      uses: actions/checkout@v1
      with:
        ref: remotes/origin/master
      shell: bash
      run: |
        git status

    - name: Checkout branch
      run: git checkout -b feature/submodule

    - name: Setup git
      env:
        ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        git config --local user.name yykaoruko
        git config --local user.email yykaoruko@gmail.com
        git remote set-url origin https://yykaoruko:${ACCESS_TOKEN}@github.com/yykaoruko/rukolog.git
      
    - name: Update submodule
      run: |
        git submodule update -i
        git submodule foreach git pull origin master
        git status

    - name: Git commit
      run: |
        git add .
        git commit -m 'update submodule'
        git status

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: 'feature/submodule'
        force: true

    - name: Create Pull Request
      env:
        GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_ACCESS_TOKEN }}
      run: >
        curl -X POST
        -H "Authorization: token ${GITHUB_ACCESS_TOKEN}"
        -H "Accept: application/vnd.github.everest-preview+json"
        -d "{\"title\": \"update submodule\", \"head\": \"feature/submodule\", \"base\": \"master\"}"
        "https://api.github.com/repos/yykaoruko/rukolog/pulls"
